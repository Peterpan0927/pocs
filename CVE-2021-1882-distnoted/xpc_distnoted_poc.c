/*
 * Compile with:
 *
 * /Users/frida/Buildbot/frida-mac/build/build/frida-macos-x86_64-clang -fPIC -Wall -Os -pipe -g3 frida-gum-example.c -o frida-gum-example -L. -lfrida-gum -lresolv -lm -isysroot /Applications/Xcode-9.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.13.sdk -arch x86_64 -Wl,-dead_strip -L/Users/frida/Buildbot/frida-mac/build/build/frida-macos-x86_64/lib -L/Users/frida/Buildbot/frida-mac/build/build/sdk-macos-x86_64/lib
 *
 * Visit www.frida.re to learn more about Frida.
 */

#include <frida-gum.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <xpc/xpc.h>
#include <pthread.h>
#include <time.h>
#include <stdlib.h>



enum _ExampleHookId
{
  XPC_CONN_SEND_MESSAGE_HOOK
};

typedef struct _ExampleListener ExampleListener;
typedef enum _ExampleHookId ExampleHookId;
char* (*f_xpc_copy_description)(void*) = NULL;

struct _ExampleListener
{
  GObject parent;
};


static void example_listener_iface_init (gpointer g_iface, gpointer iface_data);

#define EXAMPLE_TYPE_LISTENER (example_listener_get_type ())
G_DECLARE_FINAL_TYPE (ExampleListener, example_listener, EXAMPLE, LISTENER, GObject)
G_DEFINE_TYPE_EXTENDED (ExampleListener,
                        example_listener,
                        G_TYPE_OBJECT,
                        0,
                        G_IMPLEMENT_INTERFACE (GUM_TYPE_INVOCATION_LISTENER,
                            example_listener_iface_init))

__attribute__((constructor))
static void ctor(void) 
{
  GumInterceptor * interceptor;
  GumInvocationListener * listener;

  srand(time(NULL));

  // Set up frida-gum hooks
  gum_init_embedded ();

  interceptor = gum_interceptor_obtain ();
  listener = (GumInvocationListener *)g_object_new (EXAMPLE_TYPE_LISTENER, NULL);

  GumAddress f_xpc_connection_send_message = gum_module_find_export_by_name(NULL, "xpc_connection_send_message");

  gum_interceptor_begin_transaction (interceptor);

  gum_interceptor_attach (interceptor,
      GSIZE_TO_POINTER (f_xpc_connection_send_message),
      listener,
      GSIZE_TO_POINTER (XPC_CONN_SEND_MESSAGE_HOOK));

  gum_interceptor_end_transaction (interceptor);
}

static void
example_listener_on_enter (GumInvocationListener * listener,
                           GumInvocationContext * ic)
{
  ExampleListener * self = EXAMPLE_LISTENER (listener);
  ExampleHookId hook_id = GUM_IC_GET_FUNC_DATA (ic, ExampleHookId);
  char* conn_name = NULL;
  xpc_object_t cur_obj = NULL;
  xpc_connection_t cur_conn = NULL;

  switch (hook_id)
  {
    case XPC_CONN_SEND_MESSAGE_HOOK:
      cur_conn = (xpc_object_t)gum_invocation_context_get_nth_argument (ic, 0);
      conn_name = xpc_connection_get_name(cur_conn);


      if(conn_name != NULL && strcmp("com.apple.distributed_notifications@Uv3", conn_name) == 0)
      {
        cur_obj = (xpc_object_t)gum_invocation_context_get_nth_argument (ic, 1);

        if(xpc_dictionary_get_value(cur_obj, "options"))
        {
          xpc_dictionary_set_uint64(cur_obj, "options", 482162302);
        }

        if (xpc_dictionary_get_value(cur_obj, "token"))
        {
            uint64_t tok = 0x0000414141414144;
            xpc_dictionary_set_uint64(cur_obj, "token", tok);
        }

        xpc_object_t arr = xpc_dictionary_get_value(cur_obj, "tokens");
        if(arr)
        {
          uint64_t tok2 = 0x0000414141414144;
          xpc_array_set_uint64(arr, 0, tok2);
        }
      }

      break;
  }
}

static void
example_listener_on_leave (GumInvocationListener * listener,
                           GumInvocationContext * ic)
{
}

static void
example_listener_class_init (ExampleListenerClass * klass)
{
  (void) EXAMPLE_IS_LISTENER;
  (void) glib_autoptr_cleanup_ExampleListener;
}

static void
example_listener_iface_init (gpointer g_iface,
                             gpointer iface_data)
{
  GumInvocationListenerInterface * iface = (GumInvocationListenerInterface *)g_iface;

  iface->on_enter = example_listener_on_enter;
  iface->on_leave = example_listener_on_leave;
}

static void
example_listener_init (ExampleListener * self)
{
}
